<html> 
<head> 
<title>nowjs test</title> 
<script type="text/javascript" src="jquery.min.js"></script> 
<script type="text/javascript" src="raphael-min.js"></script>
<script src="/nowjs/now.js"></script>


<script>

	var t;
$(document).ready(function(){

  now.receiveState = function(state){
  	draw(state);
  }
  
  now.name = prompt("What's your name?", "");
  
  now.receiveMessageNoNotifications = function(name, message){
  	appendMessage(name,message);
  }
    
  now.receiveMessage = function(name, message){
    appendMessage(name,message);
    playSound("beeplo.wav");
		if (name != now.name)
			newMessageNotification();
  }
  
  now.receiveUserList = function(userListString) {
  	$("#users").text(userListString);
  }
  
  $("#send-button").click(function(){
    distribute();
  });
  
  $("#text-input").keypress(function(event) {
  if (event.which == 13) {
     distribute();
   }
	});

	$(window).click(function() {
  	clearMessageNotification();
  });
  
	
});

function clearMessageNotification(){
	$("#notification").text("");
	$("#notification").css("background","white");
	$("#notification").css("height","0px");
	clearTimeout(t);
}

function newMessageNotification(t){
	$("#notification").text("You have a new message!");
	$("#notification").css("background","green");
	$("#notification").css("height","80px");
	t = setTimeout("blink()",1000);
}

var blazo = true;

function blink(){	
	if (blazo == true)	{
		$("#notification").css("background","red");
		blazo = false;
		t = setTimeout("blink()",1000);
	} else {
		$("#notification").css("background","green");
		blazo = true;
		t = setTimeout("blink()",1000);
	}
}


function appendMessage(name,message){
	if (name == now.name) {
		$("#messages").append("<div class='message'>" + "<i>" + name + "</i>" + ": " + message + "</div>");
	} else {
		$("#messages").append("<div class='message'>" + name + ": " + message + "</div>");
	}
}

function distribute(){
	now.distributeMessage($("#text-input").val());
	$("#text-input").val("");
	if ($("#messages div").length > 10){
		$("#messages > div:first").remove();
	}
}

function playSound( url ){   
  document.getElementById("sound").innerHTML="<embed src='"+url+"' hidden=true autostart=true loop=false>";
}

function draw(state){
	// Creates canvas 320 Ã— 200 at 10, 50
	
	var paper = Raphael(350, 0, 320, 200);
			
		var i = 0;
		var incr;
		// Creates circle at x = 50, y = 40, with radius 10
		var circles = [];
		
		for(var i = 0; i < 5; i++){
			incr = i * 20;
			circles[i] = paper.circle(50 + incr, 40, 10);
			
			switch(state[i]){
				case 0:
					circles[i].attr("fill", "white");
					circles[i].data("color","white");
					circles[i].data("state",0);
					break;
				case 1:
					circles[i].attr("fill", "red");
					circles[i].data("color","red");
					circles[i].data("state",1);
					break;
				case 2:
					circles[i].attr("fill", "green");
					circles[i].data("color","green");
					circles[i].data("state",2);
					break;
			}
		}
	
	
	paper.forEach(function (el) {
    
    el.click(function changeColor() {
    	
			if (el.data("color") == "red") {
				el.attr("fill", "green");
				el.data("color","green");
				el.data("state",2)
			} else {
				el.attr("fill", "red");
				el.data("color","red");
				el.data("state",1)
			}
			
			now.distributeCircleState(getState());
		});
	});
	
	function getState(){
		var state = [];
		var i = 0;
		paper.forEach(function (el) {
			state[i] = el.data("state");
			i++;
		});
		//alert(state);
		return state;
	}

	for (var i = 0; i < circles.length; i++){
		//circles[i].attr("fill", "#fff");
	}

}

</script>
</head> 
 
<body> 
<div id="notification" style="font-size:26px;color:white;font-weight:bold;"></div>
<div id="messages"></div>
<div id="sound" ></div>
<div id="users" style="font-weight:bold;"></div>

<input type="text" id="text-input">
<input type="button" value="Send" id="send-button">
</body> 
</html> 
